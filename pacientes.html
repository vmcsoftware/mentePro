<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Pacientes - mentePro</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos específicos para a página de cadastro */
        .patients-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .patients-header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .patients-title h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 0;
        }

        .subtitle {
            color: #666;
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .subtitle {
            color: #666;
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary,
        .btn-secondary {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #333;
        }

        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .patients-container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <img src="assets/logo.png" alt="MentePro Logo" class="logo-img">
                <h1>mentePro</h1>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    Início
                </a>
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-chart-dashboard"></i>
                    Dashboard
                </a>
                <a href="pacientes.html" class="nav-link active">
                    <i class="fas fa-user-plus"></i>
                    Cadastro
                </a>
                <a href="agendamentos.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    Agendamentos
                </a>
                <a href="prontuarios.html" class="nav-link">
                    <i class="fas fa-file-medical"></i>
                    Prontuários
                </a>
            </nav>
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <span id="userName">Carregando...</span>
                    <button id="logoutBtn" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="patients-container">
            <!-- Header da página -->
            <div class="patients-header">
                <div class="patients-title">
                    <h1>
                        <i class="fas fa-user-plus"></i>
                        Cadastro de Pacientes
                    </h1>
                    <p class="subtitle">Registre novos pacientes no sistema mentePro</p>
                </div>
            </div>

            <!-- Alert para mensagens -->
            <div id="alertMessage" class="alert">
                <!-- Mensagens serão exibidas aqui -->
            </div>

            <!-- Formulário de cadastro -->
            <div class="form-container">
                <form id="patientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">
                                <i class="fas fa-user"></i>
                                Nome Completo *
                            </label>
                            <input type="text" id="name" name="name" required placeholder="Digite o nome completo">
                        </div>

                        <div class="form-group">
                            <label for="email">
                                <i class="fas fa-envelope"></i>
                                E-mail *
                            </label>
                            <input type="email" id="email" name="email" required placeholder="exemplo@email.com">
                        </div>

                        <div class="form-group">
                            <label for="phone">
                                <i class="fas fa-phone"></i>
                                Telefone *
                            </label>
                            <input type="tel" id="phone" name="phone" required placeholder="(11) 99999-9999">
                        </div>

                        <div class="form-group">
                            <label for="birthDate">
                                <i class="fas fa-calendar"></i>
                                Data de Nascimento *
                            </label>
                            <input type="date" id="birthDate" name="birthDate" required>
                        </div>

                        <div class="form-group">
                            <label for="cpf">
                                <i class="fas fa-id-card"></i>
                                CPF
                            </label>
                            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00">
                        </div>

                        <div class="form-group">
                            <label for="gender">
                                <i class="fas fa-venus-mars"></i>
                                Gênero
                            </label>
                            <select id="gender" name="gender">
                                <option value="">Selecione</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                                <option value="outro">Outro</option>
                                <option value="nao_informado">Prefiro não informar</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="address">
                                <i class="fas fa-map-marker-alt"></i>
                                Endereço Completo
                            </label>
                            <input type="text" id="address" name="address" placeholder="Rua, número, bairro, cidade - UF">
                        </div>

                        <div class="form-group">
                            <label for="emergencyContact">
                                <i class="fas fa-user-shield"></i>
                                Contato de Emergência
                            </label>
                            <input type="text" id="emergencyContact" name="emergencyContact" placeholder="Nome do contato">
                        </div>

                        <div class="form-group">
                            <label for="emergencyPhone">
                                <i class="fas fa-phone-alt"></i>
                                Telefone de Emergência
                            </label>
                            <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="(11) 99999-9999">
                        </div>

                        <div class="form-group">
                            <label for="profession">
                                <i class="fas fa-briefcase"></i>
                                Profissão
                            </label>
                            <input type="text" id="profession" name="profession" placeholder="Sua profissão">
                        </div>

                        <div class="form-group">
                            <label for="maritalStatus">
                                <i class="fas fa-heart"></i>
                                Estado Civil
                            </label>
                            <select id="maritalStatus" name="maritalStatus">
                                <option value="">Selecione</option>
                                <option value="solteiro">Solteiro(a)</option>
                                <option value="casado">Casado(a)</option>
                                <option value="divorciado">Divorciado(a)</option>
                                <option value="viuvo">Viúvo(a)</option>
                                <option value="uniao_estavel">União Estável</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status">
                                <i class="fas fa-toggle-on"></i>
                                Status
                            </label>
                            <select id="status" name="status">
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="notes">
                                <i class="fas fa-sticky-note"></i>
                                Observações
                            </label>
                            <textarea id="notes" name="notes" placeholder="Informações adicionais sobre o paciente..."></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <i class="fas fa-save"></i>
                            Cadastrar Paciente
                        </button>
                        <button type="button" class="btn-secondary" onclick="clearForm()">
                            <i class="fas fa-times"></i>
                            Limpar Formulário
                        </button>
                        <a href="dashboard.html" class="btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Voltar ao Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 mentePro. Todos os direitos reservados.</p>
            <div class="footer-links">
                <a href="#">Política de Privacidade</a>
                <a href="#">Termos de Uso</a>
                <a href="#">Suporte</a>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/paciente.js"></script>
    <script>
        // Verificar autenticação
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se usuário está logado
            const currentUser = sessionStorage.getItem('mentePro_currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(currentUser);
            document.getElementById('userName').textContent = user.displayName || user.email;

            // Configurar logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (window.authManager) {
                    window.authManager.handleLogout();
                } else {
                    sessionStorage.removeItem('mentePro_currentUser');
                    localStorage.removeItem('mentePro_session');
                    window.location.href = 'index.html';
                }
            });

            // Inicializar sistema de cadastro
            initializePatientRegistration();
        });

        // Inicializar sistema de cadastro
        function initializePatientRegistration() {
            const form = document.getElementById('patientForm');
            
            // Configurar máscaras
            setupInputMasks();
            
            // Configurar envio do formulário
            form.addEventListener('submit', handleFormSubmit);
        }

        // Configurar máscaras para campos
        function setupInputMasks() {
            const phoneInputs = document.querySelectorAll('input[type="tel"]');
            phoneInputs.forEach(input => {
                input.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                        if (value.length === 14) {
                            this.value = value;
                        } else if (value.length <= 10) {
                            this.value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                        }
                    }
                });
            });

            const cpfInput = document.getElementById('cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    this.value = value;
                });
            }
        }

        // Manipular envio do formulário
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Mostrar loading
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
                submitBtn.disabled = true;

                // Coletar dados do formulário
                const formData = collectFormData();
                
                // Validar dados
                if (!validateFormData(formData)) {
                    return;
                }

                // Salvar paciente
                const success = await savePatient(formData);
                
                if (success) {
                    showAlert('Paciente cadastrado com sucesso!', 'success');
                    clearForm();
                    
                    // Opcional: redirecionar após alguns segundos
                    setTimeout(() => {
                        const redirect = confirm('Paciente cadastrado! Deseja ir para o dashboard?');
                        if (redirect) {
                            window.location.href = 'dashboard.html';
                        }
                    }, 2000);
                } else {
                    showAlert('Erro ao cadastrar paciente. Tente novamente.', 'error');
                }
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showAlert('Erro inesperado. Tente novamente.', 'error');
            } finally {
                // Restaurar botão
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Coletar dados do formulário
        function collectFormData() {
            const form = document.getElementById('patientForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value.trim();
            }
            
            // Adicionar timestamps
            data.id = generatePatientId();
            data.createdAt = new Date().toISOString();
            data.updatedAt = new Date().toISOString();
            
            return data;
        }

        // Validar dados do formulário
        function validateFormData(data) {
            // Campos obrigatórios
            const required = ['name', 'email', 'phone', 'birthDate'];
            
            for (let field of required) {
                if (!data[field]) {
                    showAlert(`Campo "${getFieldLabel(field)}" é obrigatório.`, 'error');
                    document.getElementById(field).focus();
                    return false;
                }
            }
            
            // Validar email
            if (!isValidEmail(data.email)) {
                showAlert('E-mail inválido.', 'error');
                document.getElementById('email').focus();
                return false;
            }
            
            // Validar data de nascimento
            if (!isValidBirthDate(data.birthDate)) {
                showAlert('Data de nascimento inválida.', 'error');
                document.getElementById('birthDate').focus();
                return false;
            }
            
            return true;
        }

        // Salvar paciente
        async function savePatient(patientData) {
            try {
                // Tentar salvar no Firebase se disponível
                if (window.firebaseConfig && window.firebaseConfig.isInitialized) {
                    console.log('Salvando no Firebase...');
                    await window.firebaseConfig.addDocument('patients', patientData);
                    return true;
                } else {
                    // Salvar localmente como fallback
                    console.log('Firebase não disponível, salvando localmente...');
                    savePatientLocally(patientData);
                    return true;
                }
            } catch (error) {
                console.error('Erro ao salvar paciente:', error);
                // Em caso de erro, tentar salvar localmente
                savePatientLocally(patientData);
                return true;
            }
        }

        // Salvar paciente localmente
        function savePatientLocally(patientData) {
            let patients = JSON.parse(localStorage.getItem('mentePro_patients') || '[]');
            patients.push(patientData);
            localStorage.setItem('mentePro_patients', JSON.stringify(patients));
            console.log('Paciente salvo localmente:', patientData.name);
        }

        // Gerar ID único para o paciente
        function generatePatientId() {
            return 'patient_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Obter label do campo
        function getFieldLabel(field) {
            const labels = {
                name: 'Nome Completo',
                email: 'E-mail',
                phone: 'Telefone',
                birthDate: 'Data de Nascimento'
            };
            return labels[field] || field;
        }

        // Validar email
        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Validar data de nascimento
        function isValidBirthDate(birthDate) {
            const date = new Date(birthDate);
            const now = new Date();
            const minDate = new Date(now.getFullYear() - 120, now.getMonth(), now.getDate());
            
            return date >= minDate && date <= now;
        }

        // Limpar formulário
        function clearForm() {
            document.getElementById('patientForm').reset();
            hideAlert();
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alertElement = document.getElementById('alertMessage');
            if (!alertElement) return;
            
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'block';
            
            // Auto-hide após 5 segundos
            setTimeout(() => {
                hideAlert();
            }, 5000);
        }

        // Esconder alerta
        function hideAlert() {
            const alertElement = document.getElementById('alertMessage');
            if (alertElement) {
                alertElement.style.display = 'none';
            }
        }

        // Criar função global para o clear button
        window.clearForm = clearForm;
    </script>
</body>
</html>
